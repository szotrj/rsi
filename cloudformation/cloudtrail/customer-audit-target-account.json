{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description" : "Creates a CloudTrail and delivers logs to ESOC account",
   "Parameters": {
     "pConfigSupported": {
       "Description": "Support Config logs",
       "Type": "String",
       "Default": "No",
       "AllowedValues": ["Yes","No"]
     }
   },
   "Conditions" : {
     "cConfigSupported": {"Fn::Equals" : [{ "Ref" : "pConfigSupported" }, "Yes"]}
   },
   "Outputs" : {
     "CloudTrailBucket" : {
       "Description" : "CloudTrail S3 Bucket",
       "Value" : { "Fn::Sub" : "${AWS::AccountId}" }
     },
     "ConfigBucket" : {
       "Description" : "Config S3 Bucket",
       "Value" : { "Fn::Sub" : "${AWS::AccountId}" }
     }
   },
   "Resources": {
     "rCloudTrail": {
       "Type":"AWS::CloudTrail::Trail",
       "Properties": {
         "EnableLogFileValidation": true,
         "IncludeGlobalServiceEvents": true,
         "IsLogging": true,
         "IsMultiRegionTrail": true,
         "S3BucketName": { "Fn::Sub" : "${AWS::AccountId}" }
       },
     },
     "rConfigRole" : {
       "Type": "AWS::IAM::Role",
       "Condition" : "cConfigSupported",
       "Properties": {
         "AssumeRolePolicyDocument": {
           "Version": "2012-10-17",
           "Statement": [
             {
               "Effect": "Allow",
               "Principal": {
                 "Service": "config.amazonaws.com"
               },
               "Action": "sts:AssumeRole"
             }
           ]
         },
         "ManagedPolicyArns": [ {"Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSConfigRole" } ],
         "Path": "/",
         "RoleName": "FBIGOV-ESOC"
       }
     },
     "rConfigRecorder" : {
       "Type" : "AWS::Config::ConfigurationRecorder",
       "Condition": "cConfigSupported",
       "Properties" : {
         "Name" : "ConfigRecorder",
         "RecordingGroup" : {
           "AllSupported" : true,
           "IncludeGlobalResourceTypes" : true
         },
         "RoleARN" : {"Fn::GetAtt" : ["rConfigRole", "Arn"] }
       },
       "DependsOn":[
         "rConfigRole"
       ]
     },
     "rDeliveryChannel" : {
       "Type" : "AWS::Config::DeliveryChannel",
       "Condition": "cConfigSupported",
       "Properties" : {
         "Name" : "DeliveryChannel",
         "S3BucketName" : { "Fn::Sub" : "${AWS::AccountId" }
       }
     }
   }
}
