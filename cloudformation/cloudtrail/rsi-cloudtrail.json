{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Sets up CloudTrail logs and Billing reports for an account",
  "Parameters":{
    "EnvType": {
      "Description": "Environment Type",
      "Type": "String",
      "AllowedValues": ["dev", "preprod", "prod", "payer"]
    },
    "ProjectName": {
      "Description": "Project Name for System Account (lowercase)",
      "Type": "String",
      "Default": "cpmo"
    },
	  "Division": {
      "Description": "Division Number for Payer Account",
      "Type": "Number",
      "Default": "00"
	  }
  },
  "Mappings": {
    "RegionMap": {
	    "us-east-1": { "BILLINGID": "386209384616" },
	    "us-east-2": { "BILLINGID": "386209384616" },
      "us-west-1": { "BILLINGID": "386209384616" },
	    "us-west-2": { "BILLINGID": "386209384616" },
	    "us-gov-west-1": { "BILLINGID": "" },
  	  "us-isob-east-1": { "BILLINGID": "" },
	    "us-iso-east-1": { "BILLINGID": "" }
    }
  },
  "Conditions": {
    "PAYER": {"Fn::Equals": [{"Ref": "EnvType"}, "payer"]}
  },
  "Resources": {
    "CloudTrailBucket": {
      "Type": "AWS::S3::Bucket",
      "DeletionPolicy": "Delete",
      "Properties": {
        "BucketName": { "Fn::Sub": "${ProjectName}-${EnvType}-${AWS::AccountId}-cloudtrail" },
        "LoggingConfiguration": {
          "DestinationBucketName": { "Ref": "CloudTrailBucketLogging"},
          "LogFilePrefix": "cloudtrail"
        }
      }
    },
    "CloudTrailBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {"Ref": "CloudTrailBucket"},
	      "PolicyDocument": {
	        "Version": "2012-10-17",
	        "Statement": [
  	        {
	            "Sid": "AWSAclCheck",
		          "Effect": "Allow",
		          "Principal": {
	              "Service": [ "cloudtrail.amazonaws.com" ]
    	        },
		          "Action": "s3:GetBucketAcl",
		          "Resource": { "Fn::Sub": "arn:${AWS::Partition}:s3:::${ProjectName}-${EnvType}-${AWS::AccountId}-cloudtrail" }
            },
	          {
	            "Sid": "AWSCloudTrailWrite",
  	          "Effect": "Allow",
	            "Principal": {
	              "Service": [ "cloudtrail.amazonaws.com" ]
	            },
	            "Action": "s3:PutObject",
	            "Resource": { "Fn::Sub": "arn:${AWS::Partition}:s3:::${ProjectName}-${EnvType}-${AWS::AccountId}-cloudtrail/AWSLogs/${AWS::AccountId}/*" },
	            "Condition": {
  	            "StringEquals": {
	  	            "s3:x-amz-acl": "bucket-owner-full-control"
		            }
	            }
	          }
          ]
        }
      }
    },
	  "CloudTrailBucketLogging": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": { "Fn::Sub": "${ProjectName}-${EnvType}-${AWS::AccountId}-cloudtrail-logging" },
        "AccessControl": "LogDeliveryWrite"
      }
    },
	  "BillingBucket": {
      "Type": "AWS::S3::Bucket",
	    "Condition": "PAYER",
      "DeletionPolicy": "Delete",
      "Properties": {
        "BucketName": { "Fn::Sub": "div${Division}-${AWS::AccountId}-billing" },
		    "LoggingConfiguration": {
          "DestinationBucketName": { "Ref": "BillingBucketLogging"},
          "LogFilePrefix": "billing"
        }
      }
    },
	  "BillingBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
	    "Condition": "PAYER",
      "Properties": {
        "Bucket": {"Ref": "BillingBucket"},
	      "PolicyDocument": {
	        "Version": "2012-10-17",
	        "Statement": [
	          {
              "Sid": "Stmt1335892150622",
              "Effect": "Allow",
              "Principal": {
                "AWS": { "Fn::Sub": [ "arn:${AWS::Partition}:iam::${BILLINGID}:root", {"BILLINGID": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "BILLINGID"]}}] }
              },
              "Action": [
                "s3:GetBucketAcl",
                "s3:GetBucketPolicy"
              ],
              "Resource": { "Fn::Sub": "arn:${AWS::Partition}:s3:::div${Division}-${AWS::AccountId}-billing" }
            },
            {
              "Sid": "Stmt1335892526596",
              "Effect": "Allow",
              "Principal": {
                "AWS": { "Fn::Sub": [ "arn:${AWS::Partition}:iam::${BILLINGID}:root", {"BILLINGID": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "BILLINGID"]}}] }
              },
              "Action": "s3:PutObject",
              "Resource": { "Fn::Sub": "arn:${AWS::Partition}:s3:::div${Division}-${AWS::AccountId}-billing/*" }
            }
          ]
        }
      }
    },
	  "BillingBucketLogging": {
      "Type": "AWS::S3::Bucket",
	    "Condition": "PAYER",
      "Properties": {
        "BucketName": { "Fn::Sub": "div${Division}-${AWS::AccountId}-billing-logging" },
        "AccessControl": "LogDeliveryWrite"
      }
    },
    "CloudTrail": {
      "Type": "AWS::CloudTrail::Trail",
      "DeletionPolicy": "Delete",
      "Properties": {
        "IncludeGlobalServiceEvents": true,
        "IsMultiRegionTrail": true,
        "IsLogging": true,
        "S3BucketName": {
          "Ref": "CloudTrailBucket"
        },
        "EventSelectors": [
          {
            "DataResources": [
              {
                "Type": "AWS::S3::Object",
                "Values": [{ "Fn::Sub": "arn:${AWS::Partition}:s3:::" }]
              }
            ]
          }
        ]
      },
      "DependsOn": "CloudTrailBucketPolicy"
    }
  }
}
