{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Sets up CloudTrail and bucket access logging for an account, and a Billing report bucket for Payer accounts",
    "Parameters": {
        "pEnvType": {
            "Description": "Environment Type",
            "Type": "String",
            "AllowedValues": [
                "dev",
                "preprod",
                "prod",
                "payer"
            ]
        },
        "pProjectName": {
            "Description": "Project or Division Name (lowercase)",
            "Type": "String",
            "Default": ""
        },
        "pDivision": {
            "Description": "Division Number (only required for Payer accounts)",
            "Type": "Number",
            "Default": "00"
        },
        "pDestination": {
            "Description": "CloudTrail Destination",
            "Type": "String",
            "AllowedValues": [
                "local",
                "central"
            ]
        },
        "pMasterCloudTrailBucket": {
            "Description": "Master CloudTrail Bucket Name",
            "Type": "String",
            "Default": "master-cloudtrail"
        },
        "pCustomerEmail": {
            "Description": "Customer Email for Budget Alerts",
            "Type": "String",
            "Default": ""
        }
    },
    "Mappings": {
        "mRegionMap": {
            "us-east-1": {
                "BILLINGID": "386209384616",
                "BILLINGUSER": "root",
                "KMSACCOUNTID": ""
            },
            "us-east-2": {
                "BILLINGID": "386209384616",
                "BILLINGUSER": "root",
                "KMSACCOUNTID": ""
            },
            "us-west-1": {
                "BILLINGID": "386209384616",
                "BILLINGUSER": "root",
                "KMSACCOUNTID": ""
            },
            "us-west-2": {
                "BILLINGID": "386209384616",
                "BILLINGUSER": "root",
                "KMSACCOUNTID": ""
            },
            "us-gov-west-1": {
                "BILLINGID": "",
                "KMSACCOUNTID": ""
            },
            "us-isob-east-1": {
                "BILLINGID": "",
                "BILLINGUSER": "user/IAM-Programmatic-Access-Prod",
                "CAPID": "",
                "KMSACCOUNTID": ""
            },
            "us-iso-east-1": {
                "BILLINGID": "",
                "KMSACCOUNTID": ""
            }
        }
    },
    "Conditions": {
        "cPAYER": {
            "Fn::Equals": [
                {
                    "Ref": "pEnvType"
                },
                "payer"
            ]
        },
        "cCOMM": { "Fn::Or": [
            { "Fn::Equals": [{ "Ref": "AWS::Region" }, "us-east-1" ]},
            { "Fn::Equals": [{ "Ref": "AWS::Region" }, "us-east-2" ]},
            { "Fn::Equals": [{ "Ref": "AWS::Region" }, "us-west-1" ]},
            { "Fn::Equals": [{ "Ref": "AWS::Region" }, "us-west-2" ]}
        ]},
        "cSC2S": {
            "Fn::Equals": [
                {
                    "Ref": "AWS::Region"
                },
                "us-isob-east-1"
            ]
        },
        "cC2S": {
            "Fn::Equals": [
                {
                    "Ref": "AWS::Region"
                },
                "us-iso-east-1"
            ]
        },
        "cLOCAL": {
            "Fn::Equals": [
                {
                    "Ref": "pDestination"
                },
                "local"
            ]
        }
    },
    "Resources": {
        "rCloudTrailBucket": {
            "Type": "AWS::S3::Bucket",
            "Condition": "cLOCAL",
            "DeletionPolicy": "Retain",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${pProjectName}-${pEnvType}-${AWS::AccountId}-cloudtrail"
                },
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "rLoggingBucket"
                    },
                    "LogFilePrefix": "cloudtrail"
                }
            }
        },
        "rCloudTrailBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Condition": "cLOCAL",
            "Properties": {
                "Bucket": {
                    "Ref": "rCloudTrailBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSAclCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "cloudtrail.amazonaws.com"
                                ]
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::Sub": "arn:${AWS::Partition}:s3:::${pProjectName}-${pEnvType}-${AWS::AccountId}-cloudtrail"
                            }
                        },
                        {
                            "Sid": "AWSCloudTrailWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "cloudtrail.amazonaws.com"
                                ]
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "arn:${AWS::Partition}:s3:::${pProjectName}-${pEnvType}-${AWS::AccountId}-cloudtrail/AWSLogs/${AWS::AccountId}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "rBillingBucket": {
            "Type": "AWS::S3::Bucket",
            "Condition": "cPAYER",
            "DeletionPolicy": "Retain",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "div${pDivision}-${AWS::AccountId}-billing"
                },
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "rLoggingBucket"
                    },
                    "LogFilePrefix": "billing"
                }
            }
        },
        "rBillingBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Condition": "cPAYER",
            "Properties": {
                "Bucket": {
                    "Ref": "rBillingBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Stmt1335892150622",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": [
                                        "arn:${AWS::Partition}:iam::${BILLINGID}:root",
                                        {
                                            "BILLINGID": {
                                                "Fn::FindInMap": [
                                                    "mRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "BILLINGID"
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            "Action": [
                                "s3:GetBucketAcl",
                                "s3:GetBucketPolicy"
                            ],
                            "Resource": {
                                "Fn::Sub": "arn:${AWS::Partition}:s3:::div${pDivision}-${AWS::AccountId}-billing"
                            }
                        },
                        {
                            "Sid": "Stmt1335892526596",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": [
                                        "arn:${AWS::Partition}:iam::${BILLINGID}:root",
                                        {
                                            "BILLINGID": {
                                                "Fn::FindInMap": [
                                                    "mRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "BILLINGID"
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "arn:${AWS::Partition}:s3:::div${pDivision}-${AWS::AccountId}-billing/*"
                            }
                        }
                    ]
                }
            }
        },
        "rCAPTrailBucket": {
            "Type": "AWS::S3::Bucket",
            "Condition": "cSC2S",
            "DeletionPolicy": "Retain",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${pProjectName}-${pEnvType}-${AWS::AccountId}-captrail"
                },
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "rLoggingBucket"
                    },
                    "LogFilePrefix": "captrail"
                }
            }
        },
        "rCAPTrailBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Condition": "cSC2S",
            "Properties": {
                "Bucket": {
                    "Ref": "rCAPTrailBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Stmt1335892526596",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": [
                                        "arn:${AWS::Partition}:iam::${CAPID}:root",
                                        {
                                            "CAPID": {
                                                "Fn::FindInMap": [
                                                    "mRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "CAPID"
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            "Action": [
                                "s3:PutObject",
                                "s3:GetObject",
                                "s3:DeleteObject"
                            ],
                            "Resource": [
                                {
                                    "Fn::Sub": "arn:${AWS::Partition}:s3:::${pProjectName}-${pEnvType}-${AWS::AccountId}-captrail"
                                },
                                {
                                    "Fn::Sub": "arn:${AWS::Partition}:s3:::${pProjectName}-${pEnvType}-${AWS::AccountId}-captrail/*"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "rLoggingBucket": {
            "Type": "AWS::S3::Bucket",
            "DeletionPolicy": "Retain",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${pProjectName}-${pEnvType}-${AWS::AccountId}-bucket-access-logs"
                },
                "AccessControl": "LogDeliveryWrite"
            }
        },
        "rCloudTrail": {
            "Type": "AWS::CloudTrail::Trail",
            "Properties": {
                "TrailName": {
                    "Fn::Sub": "${pProjectName}-${pEnvType}-trail"
                },
                "IncludeGlobalServiceEvents": true,
                "IsLogging": true,
                "IsMultiRegionTrail": true,
                "EnableLogFileValidation": true,
                "EventSelectors": [
                    {
                        "DataResources": [
                            {
                                "Type": "AWS::S3::Object",
                                "Values": [
                                    {
                                        "Fn::Sub": "arn:${AWS::Partition}:s3:::"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "S3BucketName": {
                    "Fn::If": [
                        "cLOCAL",
                        {
                            "Ref": "rCloudTrailBucket"
                        },
                        {
                            "Ref": "pMasterCloudTrailBucket"
                        }
                    ]
                },
                "KMSKeyId": {
                  "Fn::If": [
                      "cLOCAL",
                      {
                          "Ref": "AWS::NoValue"
                      },
                      {
                          "Fn::Sub": [ "arn:${AWS::Partition}:kms:${AWS::Region}:${KMSACCOUNTID}:alias/S3MasterKey", {
                            "KMSACCOUNTID": {
                                "Fn::FindInMap": [
                                    "mRegionMap",
                                    {
                                        "Ref": "AWS::Region"
                                    },
                                    "KMSACCOUNTID"
                                ]
                            }
                          }
                          ]
                      }
                  ]
                },
                "CloudWatchLogsLogGroupArn": {
                    "Fn::GetAtt": [
                        "rCloudWatchLogsGroup",
                        "Arn"
                    ]
                },
                "CloudWatchLogsRoleArn": {
                    "Fn::GetAtt": [
                        "rCloudTrailToCloudWatchLogsRole",
                        "Arn"
                    ]
                }
            },
            "DependsOn": "rCloudTrailBucketPolicy"
        },
        "rCloudWatchLogsGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": "CloudTrailLogGroup",
                "RetentionInDays": 90
            }
        },
        "rCloudTrailToCloudWatchLogsRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "CloudTrailRole",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CloudTrailPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Sid": "CloudTrailCreateLogStream",
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "rCloudWatchLogsGroup",
                                                "Arn"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "Sid": "CloudTrailPutLogEvents",
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "rCloudWatchLogsGroup",
                                                "Arn"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "rBudget":  {
            "Type": "AWS::Budgets::Budget",
            "Condition": "cCOMM",
            "Properties": {
                "Budget": {
                    "BudgetLimit": {
                        "Amount": 1000,
                        "Unit": "USD"
                    },
                    "TimeUnit": "MONTHLY",
                    "BudgetType": "COST"            
                },
                "NotificationsWithSubscribers": [
                    {
                        "Notification": {
                            "NotificationType": "ACTUAL",
                            "ComparisonOperator": "GREATER_THAN",
                                "Threshold": 99
                        },
                        "Subscribers": [
                            {
                                "SubscriptionType": "EMAIL",
                                "Address": { "Ref": "pCustomerEmail" }
                            }
                        ]
                    },
                    {
                        "Notification": {
                            "NotificationType": "ACTUAL",
                            "ComparisonOperator": "GREATER_THAN",
                            "Threshold": 80
                        },
                        "Subscribers": [
                            {
                                "SubscriptionType": "EMAIL",
                                "Address": { "Ref": "pCustomerEmail" }
                            }
                        ]
                    }
                ]
            }
        }
    },
    "Outputs": {
        "oBillingBucketName": {
            "Condition": "cPAYER",
            "Description": "Billing S3 Bucket Name",
            "Value": {
                "Ref": "rBillingBucket"
            }
        }
    }
  }