{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Sets up CloudTrail and bucket access logging for an account, and a Billing report bucket for Payer accounts",
    "Parameters": {
        "pEnvType": {
            "Description": "Environment Type",
            "Type": "String",
            "AllowedValues": [
                "dev",
                "preprod",
                "prod",
                "payer"
            ]
        },
        "pProjectName": {
            "Description": "Project or Division Name (lowercase)",
            "Type": "String",
            "Default": ""
        },
        "pDivision": {
            "Description": "Division Number (only required for Payer accounts)",
            "Type": "Number",
            "Default": "00"
        },
        "pDestination": {
            "Description": "CloudTrail Destination",
            "Type": "String",
            "AllowedValues": [
                "local",
                "central"
            ]
        },
        "pMasterCloudTrailBucket": {
            "Description": "Master CloudTrail Bucket Name",
            "Type": "String",
            "Default": "esoc-master-cloudtrail"
        },
        "pSNSTopicName": {
            "Description": "Name of the SNS topic for CloudTrail",
            "Type": "String",
            "Default": "cloudtrail"
        }
    },
    "Mappings": {
        "mRegionMap": {
            "us-east-1": {
                "BILLINGID": "386209384616",
                "BILLINGUSER": "root"
            },
            "us-east-2": {
                "BILLINGID": "386209384616",
                "BILLINGUSER": "root"
            },
            "us-west-1": {
                "BILLINGID": "386209384616",
                "BILLINGUSER": "root"
            },
            "us-west-2": {
                "BILLINGID": "386209384616",
                "BILLINGUSER": "root"
            },
            "us-gov-west-1": {
                "BILLINGID": "",
                "CENTRALACCOUNTID": ""
            },
            "us-isob-east-1": {
                "BILLINGID": "812475063476",
                "BILLINGUSER": "user/IAM-Programmatic-Access-Prod",
                "CAPID": ""
            },
            "us-iso-east-1": {
                "BILLINGID": ""
            }
        }
    },
    "Conditions": {
        "cPAYER": {
            "Fn::Equals": [
                {
                    "Ref": "pEnvType"
                },
                "payer"
            ]
        },
        "cSC2S": {
            "Fn::Equals": [
                {
                    "Ref": "AWS::Region"
                },
                "us-isob-east-1"
            ]
        },
        "cC2S": {
            "Fn::Equals": [
                {
                    "Ref": "AWS::Region"
                },
                "us-iso-east-1"
            ]
        },
        "cLOCAL": {
            "Fn::Equals": [
                {
                    "Ref": "pDestination"
                },
                "local"
            ]
        },
        "cCENTRAL": {
            "Fn::Equals": [
                {
                    "Ref": "pDestination"
                },
                "central"
            ]
        }
    },
    "Resources": {
        "rCloudTrailSNSTopic": {
            "Type" : "AWS::SNS::Topic",
            "Condition": "cCENTRAL",
            "Properties" : {
                "DisplayName" : "CLOUDTRAIL",
                "TopicName" : { "Ref": "pSNSTopicName" }
            }
        },
        "rCloudTrailSnsTopicPolicy": {
            "Type": "AWS::SNS::TopicPolicy",
            "Condition": "cCENTRAL",
            "Properties": {
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Id": "CloudTrailSnsTopicPubSubPolicy",
                    "Statement": [
                        {
                            "Sid": "SNSRead",
                            "Effect": "Allow",
                            "Principal": "*",
                            "Action": [
                                "sns:GetTopicAttributes",
                                "sns:ListSubscriptionsByTopic"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "SNSSubscribe",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::FindInMap": [
                                        "mRegionMap",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "CENTRALACCOUNTID"
                                    ]
                                },
                                "Service": "sqs.amazonaws.com"
                            },
                            "Action": [
                                "sns:Subscribe"
                            ],
                            "Resource": { "Fn::Sub": "arn:${AWS::Partition}:sns:${AWS::Region}:${AWS::AccountId}:${pSNSTopicName}" }
                        },
                        {
                            "Sid": "CloudTrailPublish",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": [
                                "sns:Publish"
                            ],
                            "Resource": { "Fn::Sub": "arn:${AWS::Partition}:sns:${AWS::Region}:${AWS::AccountId}:${pSNSTopicName}" }
                        }
                    ]
                },
                "Topics": [{ "Ref": "rCloudTrailSNSTopic" }]
            }
        },
        "rCloudTrailBucket": {
            "Type": "AWS::S3::Bucket",
            "Condition": "cLOCAL",
            "DeletionPolicy": "Retain",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${pProjectName}-${pEnvType}-${AWS::AccountId}-cloudtrail"
                },
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "rLoggingBucket"
                    },
                    "LogFilePrefix": "cloudtrail"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "7f6f5066-cfff-4596-bac3-d8e88183e9d5"
                }
            }
        },
        "rCloudTrailBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Condition": "cLOCAL",
            "Properties": {
                "Bucket": {
                    "Ref": "rCloudTrailBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSAclCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "cloudtrail.amazonaws.com"
                                ]
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::Sub": "arn:${AWS::Partition}:s3:::${pProjectName}-${pEnvType}-${AWS::AccountId}-cloudtrail"
                            }
                        },
                        {
                            "Sid": "AWSCloudTrailWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "cloudtrail.amazonaws.com"
                                ]
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "arn:${AWS::Partition}:s3:::${pProjectName}-${pEnvType}-${AWS::AccountId}-cloudtrail/AWSLogs/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "4fdde080-c105-4e78-869f-4a46325360eb"
                }
            }
        },
        "rBillingBucket": {
            "Type": "AWS::S3::Bucket",
            "Condition": "cPAYER",
            "DeletionPolicy": "Retain",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "div${pDivision}-${AWS::AccountId}-billing"
                },
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "rLoggingBucket"
                    },
                    "LogFilePrefix": "billing"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "515cf499-4a28-4fe2-a43e-8a28f1455377"
                }
            }
        },
        "rBillingBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Condition": "cPAYER",
            "Properties": {
                "Bucket": {
                    "Ref": "rBillingBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Stmt1335892150622",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": [
                                        "arn:${AWS::Partition}:iam::${BILLINGID}:root",
                                        {
                                            "BILLINGID": {
                                                "Fn::FindInMap": [
                                                    "mRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "BILLINGID"
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            "Action": [
                                "s3:GetBucketAcl",
                                "s3:GetBucketPolicy"
                            ],
                            "Resource": {
                                "Fn::Sub": "arn:${AWS::Partition}:s3:::div${pDivision}-${AWS::AccountId}-billing"
                            }
                        },
                        {
                            "Sid": "Stmt1335892526596",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": [
                                        "arn:${AWS::Partition}:iam::${BILLINGID}:root",
                                        {
                                            "BILLINGID": {
                                                "Fn::FindInMap": [
                                                    "mRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "BILLINGID"
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "arn:${AWS::Partition}:s3:::div${pDivision}-${AWS::AccountId}-billing/*"
                            }
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "2e51e31d-2d89-4c68-aae0-b97eab5606fc"
                }
            }
        },
        "rCAPTrailBucket": {
            "Type": "AWS::S3::Bucket",
            "Condition": "cSC2S",
            "DeletionPolicy": "Retain",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${pProjectName}-${pEnvType}-${AWS::AccountId}-captrail"
                },
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "rLoggingBucket"
                    },
                    "LogFilePrefix": "captrail"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "28ae6e36-b13d-4067-aa15-399d14ce5a5b"
                }
            }
        },
        "rCAPTrailBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Condition": "cSC2S",
            "Properties": {
                "Bucket": {
                    "Ref": "rCAPTrailBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Stmt1335892526596",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": [
                                        "arn:${AWS::Partition}:iam::${CAPID}:root",
                                        {
                                            "CAPID": {
                                                "Fn::FindInMap": [
                                                    "mRegionMap",
                                                    {
                                                        "Ref": "AWS::Region"
                                                    },
                                                    "CAPID"
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            "Action": [
                                "s3:PutObject",
                                "s3:GetObject",
                                "s3:DeleteObject"
                            ],
                            "Resource": [
                                {
                                    "Fn::Sub": "arn:${AWS::Partition}:s3:::${pProjectName}-${pEnvType}-${AWS::AccountId}-captrail"
                                },
                                {
                                    "Fn::Sub": "arn:${AWS::Partition}:s3:::${pProjectName}-${pEnvType}-${AWS::AccountId}-captrail/*"
                                }
                            ]
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "21f886ae-52ce-495f-b554-84b7e5984cea"
                }
            }
        },
        "rLoggingBucket": {
            "Type": "AWS::S3::Bucket",
            "DeletionPolicy": "Retain",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${pProjectName}-${pEnvType}-${AWS::AccountId}-bucket-access-logging"
                },
                "AccessControl": "LogDeliveryWrite"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "1e880ebf-46db-43a3-b44f-e88e119cfacd"
                }
            }
        },
        "rCloudTrail": {
            "Type": "AWS::CloudTrail::Trail",
            "Properties": {
                "TrailName": {
                    "Fn::Sub": "${pProjectName}-${pEnvType}-trail"
                },
                "IncludeGlobalServiceEvents": true,
                "IsLogging": true,
                "IsMultiRegionTrail": true,
                "EnableLogFileValidation": true,
                "SnsTopicName": { "Fn::If": [ "cCENTRAL", { "Fn::GetAtt": [ "rCloudTrailSNSTopic", "TopicName" ] }, { "Ref": "AWS::NoValue"} ] },
                "EventSelectors": [
                    {
                        "DataResources": [
                            {
                                "Type": "AWS::S3::Object",
                                "Values": [
                                    {
                                        "Fn::Sub": "arn:${AWS::Partition}:s3:::"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "S3BucketName": {
                    "Fn::If": [
                        "cLOCAL",
                        {
                            "Ref": "rCloudTrailBucket"
                        },
                        {
                            "Ref": "pMasterCloudTrailBucket"
                        }
                    ]
                },
                "KMSKeyId": {
                  "Fn::If": [
                      "cLOCAL",
                      {
                          "Ref": "AWS::NoValue"
                      },
                      {
                          "Fn::Sub": [ "arn:${AWS::Partition}:kms:${AWS::Region}:${CENTRALACCOUNTID}:alias/MasterKey", 
                            {
                                "CENTRALACCOUNTID": {
                                    "Fn::FindInMap": [
                                        "mRegionMap",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                        "CENTRALACCOUNTID"
                                    ]
                                }
                            }
                          ]
                      }
                  ]
                },
                "CloudWatchLogsLogGroupArn": {
                    "Fn::GetAtt": [
                        "rCloudWatchLogsGroup",
                        "Arn"
                    ]
                },
                "CloudWatchLogsRoleArn": {
                    "Fn::GetAtt": [
                        "rCloudTrailToCloudWatchLogsRole",
                        "Arn"
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "00423070-969b-4dd5-b948-6a7854c94346"
                }
            },
            "DependsOn": "rCloudTrailSnsTopicPolicy"
        },
        "rCloudWatchLogsGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": "CloudTrailLogGroup",
                "RetentionInDays": 90
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "743dd2d5-9a3f-44b0-857b-fc66a6f2d32f"
                }
            }
        },
        "rCloudTrailToCloudWatchLogsRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "CloudTrailRole",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CloudTrailPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Sid": "CloudTrailCreateLogStream",
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream"
                                    ],
                                    "Resource": [
                                        { 
                                            "Fn::GetAtt": [
                                                "rCloudWatchLogsGroup",
                                                "Arn"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "Sid": "CloudTrailPutLogEvents",
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": [
                                        { 
                                            "Fn::GetAtt": [
                                                "rCloudWatchLogsGroup",
                                                "Arn"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "4b51f93b-3821-4ea9-85ae-5f6c4a072484"
                }
            }
        }
    },
    "Outputs": {
        "oBillingBucketName": {
            "Condition": "cPAYER",
            "Description": "Billing S3 Bucket Name",
            "Value": {
                "Ref": "rBillingBucket"
            }
        },
        "oCloudTrailSNSTopicARN": {
            "Condition": "cCENTRAL",
            "Description": "ARN of the SNS topic for CloudTrail",
            "Value": {
                "Ref": "rCloudTrailSNSTopic"
            }
        }
    }
  }