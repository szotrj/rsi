{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Creates a maseter S3 bucket to store logs from external accounts",
  "Parameters": {
    "BucketName": {
      "Description": "Name of the central bucket",
      "Type": "String",
      "Default": "esoc-master-logs"
    },
    "pConfigSupported": {
      "Description": "Support Config logs",
      "Type": "String",
      "Default": "No",
      "AllowedValues": ["Yes","No"]
    }
  },
  "Conditions": {
    "cConfigSupported": { "Fn::Equals": [ {"Ref": "pConfigSupported"}, "Yes"]}
  },
  "Resources": {
    "rArchiveLogsBucket": {
        "Type": "AWS::S3::Bucket",
        "DeletionPolicy": "Retain",
        "Properties": {
            "BucketName": { "Fn::Sub": "${BucketName}-archive" },
            "AccessControl": "LogDeliveryWrite",
            "LifecycleConfiguration": {
                "Rules": [
                    {
                        "Id": "Transition90daysRetain7yrs",
                        "Status": "Enabled",
                        "ExpirationInDays": 2555,
                        "Transition": {
                            "TransitionInDays": 90,
                            "StorageClass": "STANDARD_IA"
                        }
                    }
                ]
            },
            "VersioningConfiguration": {
                "Status": "Enabled"
            }
        }
    },
    "rArchiveLogsBucketPolicy": {
        "Type": "AWS::S3::BucketPolicy",
        "Properties": {
            "Bucket": {
                "Ref": "rArchiveLogsBucket"
            },
            "PolicyDocument": {
                "Statement": [
                    {
                        "Sid": "Enforce HTTPS Connections",
                        "Action": "s3:*",
                        "Effect": "Deny",
                        "Principal": "*",
                        "Resource": {
                            "Fn::Sub": "arn:${AWS::Partition}:s3:::${rArchiveLogsBucket}/*"
                        },
                        "Condition": {
                            "Bool": {
                                "aws:SecureTransport": false
                            }
                        }
                    },
                    {
                        "Sid": "Restrict Delete* Actions",
                        "Action": "s3:Delete*",
                        "Effect": "Deny",
                        "Principal": "*",
                        "Resource": {
                            "Fn::Sub": "arn:${AWS::Partition}:s3:::${rArchiveLogsBucket}/*"
                        }
                    }
                ]
            }
        },
        "DependsOn": [
          "rArchiveLogsBucket"
        ]
    },
    "rMasterBucket": {
      "Type": "AWS::S3::Bucket",
      "DeletionPolicy": "Retain",
      "Properties": {
        "BucketName": { "Ref": "BucketName" },
        "AccessControl": "Private",
        "VersioningConfiguration": {
            "Status": "Enabled"
        },
        "LoggingConfiguration": {
            "DestinationBucketName": {
                "Ref": "rArchiveLogsBucket"
            },
            "LogFilePrefix": "cloudtrail"
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "KMSMasterKeyID": { "Ref": "rS3BucketKey" },
                "SSEAlgorithm": "aws:kms"
              }
            }
          ]
        },
        "Tags": []
      }
    },
    "rMasterBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {"Ref": "rMasterBucket"},
          "PolicyDocument":
          {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "AWSAclCheck",
                    "Effect": "Allow",
                    "Principal": {
                    "Service": [ "cloudtrail.amazonaws.com", { "Fn::If": [ "cConfigSupported", "config.amazonaws.com", { "Ref": "AWS::NoValue" } ] } ]
                    },
                    "Action": "s3:GetBucketAcl",
                    "Resource": { "Fn::Sub": "arn:${AWS::Partition}:s3:::${rMasterBucket}" }
                },
                {
                  "Sid": "AWSCloudTrailWrite",
                  "Effect": "Allow",
                  "Principal": {
                    "Service": [ "cloudtrail.amazonaws.com", { "Fn::If": [ "cConfigSupported", "config.amazonaws.com", { "Ref": "AWS::NoValue" } ] } ]
                  },
                  "Action": "s3:PutObject",
                  "Resource": { "Fn::Sub": "arn:${AWS::Partition}:s3:::${rMasterBucket}/AWSLogs*" },
                  "Condition": {
                    "StringEquals": {
                        "s3:x-amz-acl": "bucket-owner-full-control"
                      }
                  }
                },
                {
                  "Sid": "Restrict Delete* Actions",
                  "Action": "s3:Delete*",
                  "Effect": "Deny",
                  "Principal": "*",
                  "Resource": {
                      "Fn::Sub": "arn:${AWS::Partition}:s3:::${rMasterBucket}/*"
                  }
              },
              {
                "Sid": "Enforce HTTPS Connections",
                "Action": "s3:*",
                "Effect": "Deny",
                "Principal": "*",
                "Resource": {
                  "Fn::Sub": "arn:${AWS::Partition}:s3:::${rMasterBucket}/*"
                },
                "Condition": {
                  "Bool": {
                    "aws:SecureTransport": false
                  }
                }
              }
            ]
          }
      },
      "DependsOn": [
        "rMasterBucket"
      ]
    },
    "rS3BucketKey": {
        "Type": "AWS::KMS::Key",
        "Properties": {
          "Description": "CMK for S3 bucket encryption",
          "Enabled": true,
          "EnableKeyRotation": true,
          "KeyPolicy": {
            "Version": "2012-10-17",
            "Id": "key-default-1",
            "Statement": [
              {
                "Sid": "Allow administration of the key",
                "Effect": "Allow",
                "Principal": { 
                  "AWS": [
                    { "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/ADMINISTRATOR" },
                    { "Fn::Sub": "arn:${AWS::Partition}:sts::${AWS::AccountId}:assumed-role/FBIGOV-XAdmin/RJSZOT@FBI.GOV" }
                  ]
                },
                "Action": [
                  "kms:Create*",
                  "kms:Describe*",
                  "kms:Enable*",
                  "kms:List*",
                  "kms:Put*",
                  "kms:Update*",
                  "kms:Revoke*",
                  "kms:Disable*",
                  "kms:Get*",
                  "kms:Delete*",
                  "kms:ScheduleKeyDeletion",
                  "kms:CancelKeyDeletion"
                ],
                "Resource": "*"
              },
              {
                "Sid": "Allow use of the key",
                "Effect": "Allow",
                "Principal": { 
                  "AWS": [
                    { "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:user/esoc-admin" }
                  ],
                  "Service": "cloudtrail.amazonaws.com"
                },
                "Action": [
                  "kms:Encrypt",
                  "kms:Decrypt",
                  "kms:ReEncrypt*",
                  "kms:GenerateDataKey*",
                  "kms:DescribeKey"
                ], 
                "Resource": "*"
              }    
            ]
          }
        }
      },
      "rS3KeyAlias": {
        "Type": "AWS::KMS::Alias",
        "Properties": {
          "AliasName": "alias/S3MasterKey",
          "TargetKeyId": { "Ref":"rS3BucketKey" }
        }
      }
  },
  "Outputs": {
  }
}
