{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Creates a Kinesis Stream, CloudWatch Logs destination, CloudWatch to Kinesis role, and a CloudWatch Logs Subscription Filter",
  "Parameters": {
    "pVPCFlowLogGroupName": {
      "Description": "Name of VPC Flow Log CloudWatch Logs Group",
      "Type": "String",
      "Default": ""
    },
    "pLogsDestinationName": {
      "Description": "Name of the CloudWatch Logs Destination",
      "Type": "String",
      "Default": "logsDestination"
    },
    "pKinesisStreamName": {
      "Description": "Name of the Kinesis Stream",
      "Type": "String",
      "Default": "FLOW-LOGS-STREAM"
    },
    "pCWLtoKinesisRoleRoleName": {
      "Description": "Name of the CloudWatch Logs to Kinesis role ",
      "Type": "String",
      "Default": "CWLtoKinesisRole"
    }
  },
  "Resources": {
    "rCWLtoKinesisRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": { "Ref": "pCWLtoKinesisRoleRoleName" },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [ {
            "Effect": "Allow",
            "Principal": {
              "Service": { "Fn::Sub": "logs.${AWS::Region}.amazonaws.com" }
            },
            "Action": "sts:AssumeRole"
          } ]
        },
        "Policies": [
          {
            "PolicyName": "Permissions-Policy-For-CWL",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "kinesis:PutRecord",
                    "iam:PassRole"
                  ],
                  "Resource": [
                    { "Fn::Sub": "arn:${AWS::Partition}:iam::*:role/${pCWLtoKinesisRoleRoleName}" },
                    { "Fn::Sub": "arn:${AWS::Partition}:kinesis:${AWS::Region}:*:stream/${pKinesisStreamName}" }
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "rKinesisStream": {
      "Type" : "AWS::Kinesis::Stream",
      "Properties" : {
        "Name": { "Ref": "pKinesisStreamName" },
        "RetentionPeriodHours": 24,
        "ShardCount": 1,
      }
    },
    "rCloudWatchLogsDestination": {
      "Type": "AWS::Logs::Destination",
      "Properties": {
        "DestinationName": { "Ref": "pLogsDestinationName" },
        "DestinationPolicy": { "Fn::Sub": "{
          \"Version\": \"2012-10-17\",
          \"Statement\": [
            {
              \"Effect\": \"Allow\",
              \"Principal\": {
                \"AWS\": \"*\"
              },
              \"Action\": \"logs:PutSubscriptionFilter\",
              \"Resource\": \"arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:destination:${pLogsDestinationName}\"
            }
          ]
        }" },
        "RoleArn": { "Fn::GetAtt": [ "rCWLtoKinesisRole", "Arn" ] },
        "TargetArn":  { "Fn::GetAtt": [ "rKinesisStream", "Arn" ] }
      }
    },
    "rCWLSubscriptionFilter": {
      "Type": "AWS::Logs::SubscriptionFilter",
      "Properties": {
        "DestinationArn": { "Fn::GetAtt" : [ "rKinesisStream", "Arn" ] },
        "FilterPattern": "",
        "LogGroupName": {"Ref": "pVPCFlowLogGroupName"},
        "RoleArn": { "Fn::GetAtt" : [ "rCWLtoKinesisRole", "Arn" ] }
      }
    }
  },
  "Outputs": {
    "oCloudWatchLogstoKinesisRoleArn": {
      "Description": "ARN of the CloudWatch Logs to Kinesis role",
      "Value": { "Fn::GetAtt" : [ "rCWLtoKinesisRole", "Arn" ] }
    },
    "oKinesisStreamArn": {
      "Description": "ARN of the Kinesis Stream",
      "Value": { "Fn::GetAtt" : [ "rKinesisStream", "Arn" ] }
    }
  }
}
